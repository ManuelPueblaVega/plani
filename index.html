<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Planes de Clase de M√∫sica</title>
    <!-- Tailwind CSS CDN para un estilo r√°pido y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Un color de fondo suave */
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 960px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1rem; /* Bordes m√°s redondeados */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); /* Sombra m√°s pronunciada */
        }
        h1, h2, h3 {
            color: #2c3e50;
            font-weight: 700;
        }
        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2.5rem; /* T√≠tulo m√°s grande */
            color: #3498db; /* Un azul vibrante */
        }
        label {
            font-weight: 600;
            color: #4a5568;
        }
        select, button {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e0;
            font-size: 1rem;
            transition: all 0.2s ease-in-out;
        }
        select:focus, button:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
        }
        button {
            background-color: #3498db;
            color: white;
            cursor: pointer;
            font-weight: 600;
            border: none;
        }
        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px); /* Efecto ligero al pasar el rat√≥n */
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        #lessonPlanOutput {
            margin-top: 2.5rem;
            padding: 2rem;
            background-color: #ecf0f1; /* Fondo gris claro para el plan */
            border-radius: 0.75rem;
            border: 1px dashed #bdc3c7; /* Borde punteado suave */
        }
        .lesson-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-left: 5px solid; /* Borde izquierdo de color para las secciones */
            border-radius: 0.5rem;
            background-color: #ffffff; /* Fondo blanco para las secciones */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .lesson-section h3 {
            margin-top: 0;
            margin-bottom: 0.75rem;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
        }
        .lesson-section h3::before {
            content: 'üéµ'; /* Icono musical antes del t√≠tulo */
            margin-right: 0.5rem;
            font-size: 1.2em;
        }

        /* Colores para los bordes de las secciones (similares a la imagen del curr√≠culum) */
        .section-warmup { border-color: #27ae60; } /* Verde para Calentamiento */
        .section-rhythm { border-color: #e67e22; } /* Naranja para Ritmo */
        .section-melody { border-color: #9b59b6; } /* P√∫rpura para Melod√≠a */
        .section-instrumental { border-color: #34495e; } /* Azul oscuro para Instrumental */
        .section-movement { border-color: #e74c3c; } /* Rojo para Movimiento */
        .section-creative { border-color: #f1c40f; } /* Amarillo para Creativo */
        .section-listening { border-color: #1abc9c; } /* Turquesa para Escucha */
        .section-closing { border-color: #8e44ad; } /* Violeta para Cierre */

        .section-content ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            padding: 0;
        }
        .section-content li {
            margin-bottom: 0.5rem;
        }
        .concept-tag {
            display: inline-block;
            background-color: #dbeafe; /* Light blue background */
            color: #1e40af; /* Dark blue text */
            padding: 0.2em 0.6em;
            border-radius: 0.5rem;
            font-size: 0.85em;
            margin-right: 0.5rem;
            margin-bottom: 0.3rem;
            font-weight: 500;
        }
        .methodology-note {
            font-style: italic;
            color: #555;
            margin-top: 0.75rem;
            padding-left: 0.5rem;
            border-left: 3px solid #ccc;
        }
        .llm-suggestion {
            margin-top: 1rem;
            padding: 0.75rem;
            background-color: #e0f2f7; /* Un azul muy claro */
            border-left: 4px solid #007bff; /* Un azul m√°s oscuro */
            border-radius: 0.5rem;
            font-size: 0.9em;
            color: #333;
        }
        .llm-loading {
            text-align: center;
            font-style: italic;
            color: #666;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Generador de Planes de Clase de M√∫sica</h1>

        <div class="flex flex-col md:flex-row gap-4 mb-8 justify-center">
            <div class="flex-1">
                <label for="ageRange" class="block mb-2 text-gray-700">Rango de Edad:</label>
                <select id="ageRange" class="w-full">
                    <option value="preschool">Preescolar (3-5 a√±os)</option>
                    <option value="1st-grade">1ero B√°sico (6-7 a√±os)</option>
                    <option value="2nd-grade">2do B√°sico (7-8 a√±os)</option>
                    <option value="3rd-4th-grade">3ro/4to B√°sico (8-10 a√±os)</option>
                    <option value="5th-grade">5to B√°sico (10-11 a√±os)</option>
                </select>
            </div>
            <div class="flex-1">
                <label for="classDuration" class="block mb-2 text-gray-700">Duraci√≥n de la Clase:</label>
                <select id="classDuration" class="w-full">
                    <option value="30">30 minutos</option>
                    <option value="45">45 minutos</option>
                    <option value="60">60 minutos</option>
                </select>
            </div>
            <div class="flex-1 flex items-end">
                <button id="generatePlanBtn" class="w-full h-auto">Generar Plan de Clase</button>
            </div>
        </div>

        <div id="lessonPlanOutput" class="hidden">
            <!-- El plan de clase generado se insertar√° aqu√≠ -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const generatePlanBtn = document.getElementById('generatePlanBtn');
            const ageRangeSelect = document.getElementById('ageRange');
            const classDurationSelect = document.getElementById('classDuration');
            const lessonPlanOutput = document.getElementById('lessonPlanOutput');

            // Definici√≥n del curr√≠culum por rango de edad, basada en el PDF proporcionado
            const curriculum = {
                'preschool': {
                    label: 'Preescolar (3-5 a√±os)',
                    rhythm: ['Sonido/Silencio', 'Largo/Corto', 'Pulso'],
                    melody: ['Voz hablada/cantada', 'Agudo/Grave', 'Sol-Mi', 'Canon a 2'],
                    form: ['Igual/Diferente'],
                    texture: ['Solo/Grupo'],
                    expression: ['Fuerte/Suave', 'Lento/R√°pido'], // 'Fuerte/Suave' del PDF
                    other: ['Canciones infantiles', 'Percusi√≥n en instrumentos de altura indeterminada']
                },
                '1st-grade': {
                    label: '1ero B√°sico (6-7 a√±os)',
                    rhythm: ['Pulso', 'Ritmo', 'Comp√°s en 2', 'Negra', 'Corcheas (Ti-ti)', 'Silencio de Negra'], // A√±adido 'Silencio de Negra'
                    melody: ['Voz cantada', 'Sol-Mi-La', 'Canto afinado'], // 'Sol, la, sol, mi' del PDF
                    form: ['AA', 'AB'],
                    texture: ['Solo/Grupo', 'Ostinato', 'Bord√≥n'], // A√±adido 'Bord√≥n'
                    expression: ['Forte/Piano', 'Lento/R√°pido', 'Acento', 'Repetir signos'], // A√±adido 'Repetir signos' y 'Acento'
                    other: ['Canciones folcl√≥ricas', 'Instrumentos Orff', 'Audici√≥n'] // A√±adido 'Audici√≥n'
                },
                '2nd-grade': {
                    label: '2do B√°sico (7-8 a√±os)',
                    rhythm: ['Pulso', 'Ritmo', 'Comp√°s en 3', 'Blanca (Taa)', 'Redonda', 'Semicorcheas (Taca-taca)', '4/4'], // Ajustado y a√±adido del PDF
                    melody: ['Voces cantadas', 'Do (Re, mi)', 'Escala pentat√≥nica', 'Escala de Do-Fa y Sol', 'Canto afinado'], // Ajustado y a√±adido del PDF
                    form: ['AB', 'AAB', 'Frase de 8 tiempos', 'Pregunta y respuesta'], // Ajustado y a√±adido del PDF
                    texture: ['Ostinato', 'Bord√≥n', 'Canciones a m√°s de una voz'], // A√±adido del PDF
                    expression: ['Crescendo/Decrescendo', 'Allegro/Andante', 'Acento'], // Acento ya cubierto, pero lo mantengo
                    other: ['Instrumentos de la orquesta', 'Lectura r√≠tmica (pulso/ritmo)', 'Primera y segunda terminaci√≥n'] // A√±adido del PDF
                },
                '3rd-4th-grade': {
                    label: '3ro/4to B√°sico (8-10 a√±os)',
                    rhythm: ['Comp√°s en 4', 'Semicorcheas (galopa, etc.)', 'Blanca con punto', 'Comp√°s en 3', 'Anacrusa', 'Tresillo', 'Silencio de corchea'], // Ajustado y a√±adido del PDF
                    melody: ['Escalas diat√≥nicas', 'Escala pentat√≥nica de La-Re y Mi La grave', 'Sol grave', 'Fa', 'Si', 'Escala menor de La. Hexat√≥nica', 'Modos (mayor/menor)', 'Armon√≠a a 2 partes', 'C√°nones'], // Ajustado y a√±adido del PDF
                    form: ['Rond√≥', 'Tema y Variaciones'],
                    texture: ['Bord√≥n', 'C√°nones', 'Armon√≠a a 2 partes', 'Cantos a m√°s de dos voces', 'Acordes de T√≥nica y Dominante', 'Bord√≥n arpegiado', 'Armon√≠a a 2 partes y contra'], // Ajustado y a√±adido del PDF
                    expression: ['Allegro', 'Andante', 'Moderato', 'Mezzo-forte', 'Mezzo-piano', 'Legato/Staccato', 'Fraseo'], // Ajustado y a√±adido del PDF
                    other: ['Clave de Sol', 'Llave de Fa?', 'G√©neros musicales', 'Instrumentos de la orquesta'] // Ajustado y a√±adido del PDF
                },
                '5th-grade': {
                    label: '5to B√°sico (10-11 a√±os)',
                    rhythm: ['Compases compuestos (6/8, 9/8, 12/8)', 'Patrones r√≠tmicos complejos', 'Cortar el tiempo'], // Ajustado y a√±adido del PDF
                    melody: ['Clave de Sol', 'Escala mayor', 'Secuencia', 'Dorio/Mixolidio/Frigio/Lidio', 'Acordes (T√≥nica, Dominante, Subdominante)', 'Armon√≠a funcional', 'Inversiones de acordes'], // Ajustado y a√±adido del PDF
                    form: ['Sonata', 'Fuga (introducci√≥n)', 'Tema y Variaciones', 'Chacona'], // A√±adido del PDF
                    texture: ['Armon√≠a a 2+ partes', 'Acordes', 'Armon√≠a funcional'], // 'Armon√≠a funcional' es m√°s general
                    expression: ['Rubato', 'Din√°micas m√°s sutiles', 'Da capo; al inicio'], // Ajustado y a√±adido del PDF
                    other: ['Signos de repetici√≥n', 'L√≠neas de comp√°s', 'Dictado musical', 'An√°lisis de obras', 'Grados de escala'] // Ajustado y a√±adido del PDF
                }
            };

            // Distribuci√≥n de tiempo porcentual para cada secci√≥n
            const timeDistributionPercentages = {
                'welcome': 0.10, // Bienvenida y Calentamiento
                'rhythm': 0.15, // Desarrollo R√≠tmico
                'melody': 0.15, // Desarrollo Mel√≥dico y Vocal
                'instrumental': 0.20, // Exploraci√≥n Instrumental
                'movement': 0.15, // Movimiento y Expresi√≥n
                'creative': 0.10, // Actividad Creativa / Improvisaci√≥n
                'listening': 0.10, // Escucha Activa y Apreciaci√≥n
                'closing': 0.05  // Cierre y Relajaci√≥n
            };

            // Gemini API configuration
            const API_KEY = ""; // Canvas will provide this in runtime
            const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

            /**
             * Calls the Gemini API to generate content.
             * @param {string} prompt The prompt for the LLM.
             * @returns {Promise<string>} The generated text.
             */
            async function callGeminiAPI(prompt) {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };

                try {
                    const response = await fetch(`${API_URL}?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        console.error("Unexpected API response structure:", result);
                        return "No se pudo generar la sugerencia. Int√©ntalo de nuevo.";
                    }
                } catch (error) {
                    console.error("Error calling Gemini API:", error);
                    return "Error al conectar con la IA. Por favor, revisa tu conexi√≥n.";
                }
            }

            /**
             * Generates LLM content and displays it.
             * @param {string} sectionKey The key for the current section (e.g., 'rhythm').
             * @param {string} ageRange The selected age range key.
             * @param {'activity' | 'assessment'} type The type of content to generate.
             * @param {object} currentCurriculum The curriculum object for the selected age range.
             */
            async function generateLLMContent(sectionKey, ageRange, type, currentCurriculum) {
                const sectionNameMap = {
                    'welcome': 'Bienvenida y Calentamiento',
                    'rhythm': 'Desarrollo R√≠tmico',
                    'melody': 'Desarrollo Mel√≥dico y Vocal',
                    'instrumental': 'Exploraci√≥n Instrumental',
                    'movement': 'Movimiento y Expresi√≥n',
                    'creative': 'Actividad Creativa / Improvisaci√≥n / Composici√≥n Elemental',
                    'listening': 'Escucha Activa y Apreciaci√≥n / "Otro"',
                    'closing': 'Cierre y Relajaci√≥n'
                };

                const sectionElementName = sectionKey; // Corresponds to the section in HTML
                const sectionContentDiv = document.getElementById(`${sectionElementName}-llm-output-${type}`);
                const ageLabel = currentCurriculum.label;
                const sectionDisplayTitle = sectionNameMap[sectionKey];

                if (!sectionContentDiv) {
                    console.error(`Output div not found for section: ${sectionElementName}, type: ${type}`);
                    return;
                }

                sectionContentDiv.innerHTML = '<div class="llm-loading">Cargando sugerencia...</div>';

                let prompt = "";
                const relevantCurriculumConcepts = Object.values(currentCurriculum)
                                                .filter(Array.isArray)
                                                .flat()
                                                .join(', '); // Get all concepts for the age

                if (type === 'activity') {
                    prompt = `Eres un experto dise√±ador curricular de educaci√≥n musical con profundos conocimientos en metodolog√≠as activas (Orff Schulwerk, Kod√°ly, Dalcroze Eurhythmics, Music Learning Theory de Gordon). Dada la edad del grupo (${ageLabel}) y la secci√≥n del plan de clase "${sectionDisplayTitle}", genera UNA actividad adicional creativa y pr√°ctica que integre conceptos clave de las metodolog√≠as mencionadas y que est√© alineada con el curr√≠culum de este nivel. Los conceptos clave del curr√≠culum para esta secci√≥n son: ${relevantCurriculumConcepts}. No uses introducciones ni conclusiones, solo la descripci√≥n de la actividad.`;
                } else if (type === 'assessment') {
                    prompt = `Eres un experto dise√±ador curricular de educaci√≥n musical. Dada la edad del grupo (${ageLabel}) y la secci√≥n del plan de clase "${sectionDisplayTitle}", sugiere UNA idea de evaluaci√≥n FORMATIVA simple y pr√°ctica para esta secci√≥n. Debe estar alineada con los conceptos clave del curr√≠culum para esta secci√≥n: ${relevantCurriculumConcepts}. No uses introducciones ni conclusiones, solo la descripci√≥n de la idea de evaluaci√≥n.`;
                }

                const generatedText = await callGeminiAPI(prompt);
                sectionContentDiv.innerHTML = `<div class="llm-suggestion">${generatedText}</div>`;
            }

            generatePlanBtn.addEventListener('click', () => {
                const ageRange = ageRangeSelect.value;
                const duration = parseInt(classDurationSelect.value);
                const currentCurriculum = curriculum[ageRange];
                const ageLabel = curriculum[ageRange].label;

                // Calcular el tiempo asignado a cada secci√≥n
                const sectionTimes = {};
                for (const section in timeDistributionPercentages) {
                    sectionTimes[section] = Math.round(duration * timeDistributionPercentages[section]);
                }

                let htmlContent = `
                    <h2 class="text-2xl font-bold mb-4 text-center">Plan de Clase: M√∫sica para ${ageLabel} (${duration} minutos)</h2>
                    <p class="text-md mb-6 text-gray-600 italic text-center">Este es un plan flexible. ¬°Adapta las actividades y el tiempo seg√∫n las necesidades de tu grupo!</p>
                `;

                // Common HTML structure for sections
                const sectionTemplate = (sectionKey, title, time, contentHtml, curriculumConcepts) => `
                    <div class="lesson-section section-${sectionKey}" id="${sectionKey}-section">
                        <h3>${title} <span class="text-sm font-normal ml-2">(${time} min)</span></h3>
                        <div class="section-content">
                            ${contentHtml}
                            <div class="mt-4 flex flex-col sm:flex-row gap-2">
                                <button class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md text-sm transition-all duration-200 ease-in-out" data-section="${sectionKey}" data-type="activity">
                                    ‚ú® Sugerir Actividad Adicional
                                </button>
                                <button class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md text-sm transition-all duration-200 ease-in-out" data-section="${sectionKey}" data-type="assessment">
                                    ‚ú® Sugerir Idea de Evaluaci√≥n
                                </button>
                            </div>
                            <div id="${sectionKey}-llm-output-activity" class="llm-suggestion hidden mt-3"></div>
                            <div id="${sectionKey}-llm-output-assessment" class="llm-suggestion hidden mt-3"></div>
                        </div>
                    </div>
                `;

                // 1. Objetivos de Aprendizaje Clave (no tiene botones LLM)
                htmlContent += `
                    <div class="lesson-section section-warmup">
                        <h3>Objetivos de Aprendizaje Clave <span class="text-sm font-normal ml-2">(Enfoque General)</span></h3>
                        <div class="section-content">
                            <ul class="list-disc ml-6">
                                <li>Desarrollar la sensibilidad auditiva y el reconocimiento de elementos musicales b√°sicos.</li>
                                <li>Fomentar la expresi√≥n a trav√©s de la voz, el cuerpo y los instrumentos.</li>
                                <li>Explorar conceptos r√≠tmicos y mel√≥dicos de forma activa y l√∫dica.</li>
                                <li>Estimular la creatividad y la improvisaci√≥n musical.</li>
                                <li>Promover la interacci√≥n grupal y el disfrute de la m√∫sica.</li>
                                <li>Integrar conceptos clave del curr√≠culum como: ${Object.values(currentCurriculum).filter(Array.isArray).flat().map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                            </ul>
                        </div>
                    </div>
                `;

                // 2. Materiales Necesarios (no tiene botones LLM)
                htmlContent += `
                    <div class="lesson-section section-rhythm">
                        <h3>Materiales Necesarios <span class="text-sm font-normal ml-2">(Sugerencias)</span></h3>
                        <div class="section-content">
                            <ul class="list-disc ml-6">
                                <li>Instrumentos de percusi√≥n menor (claves, maracas, panderos, tri√°ngulos).</li>
                                <li>Instrumentos Orff (xil√≥fonos, metal√≥fonos, glockenspiels).</li>
                                <li>Pa√±uelos, pelotas peque√±as, aros (para movimiento).</li>
                                <li>Pizarr√≥n o papel√≥grafo.</li>
                                <li>Reproductor de audio y parlantes.</li>
                                <li>Tarjetas con figuras r√≠tmicas (opcional, relacionadas con: ${currentCurriculum.rhythm.map(c => `<span class="concept-tag">${c}</span>`).join('')}).</li>
                                <li>Libros de canciones infantiles o folcl√≥ricas (que contengan: ${currentCurriculum.melody.map(c => `<span class="concept-tag">${c}</span>`).join('')}).</li>
                            </ul>
                        </div>
                    </div>
                `;

                // 3. Desarrollo de la Clase (con tiempos aproximados)
                // a. Bienvenida y Calentamiento
                htmlContent += sectionTemplate(
                    'welcome',
                    'a. Bienvenida y Calentamiento (Voz, Cuerpo, O√≠do)',
                    sectionTimes['welcome'],
                    `
                    <ul class="list-disc ml-6">
                        <li><strong>Canci√≥n de saludo:</strong> "Hola, hola, ¬øc√≥mo est√°s?" o similar. Los alumnos se saludan con un gesto o movimiento.</li>
                        <li><strong>Preparaci√≥n Vocal y Corporal (Dalcroze, Kod√°ly):</strong>
                            <ul>
                                <li>Caminar al pulso de la m√∫sica, cambiando de direcci√≥n o nivel (Dalcroze).</li>
                                <li>Juego de eco de vocalizaciones con s√≠labas (ej: "Maa-mee-moo") para explorar <strong>${currentCurriculum.melody.includes('Agudo/Grave') ? 'Agudo/Grave' : 'el rango vocal'}</strong>.</li>
                                <li>Imitar sonidos de animales con la voz, explorando diferentes timbres.</li>
                            </ul>
                        </li>
                        <li><strong>Juegos de eco r√≠tmico (Kod√°ly, Gordon):</strong> El profesor palmotea un patr√≥n r√≠tmico simple y los alumnos repiten.
                            <span class="methodology-note">üí° Sugerencia: Inicia con patrones b√°sicos como el <strong>${currentCurriculum.rhythm.includes('Pulso') ? 'pulso' : 'ritmo'}</strong> o el <strong>${currentCurriculum.rhythm.includes('Negra') ? 'ritmo de negra' : 'ritmo simple'}</strong>, incorporando: ${currentCurriculum.rhythm.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</span>
                        </li>
                    </ul>
                    `,
                    currentCurriculum.rhythm.concat(currentCurriculum.melody).join(', ')
                );

                // b. Desarrollo R√≠tmico
                htmlContent += sectionTemplate(
                    'rhythm',
                    'b. Desarrollo R√≠tmico',
                    sectionTimes['rhythm'],
                    `
                    <ul class="list-disc ml-6">
                        <li><strong>Exploraci√≥n del Pulso y Ritmo (Kod√°ly):</strong>
                            <ul>
                                <li>Caminar, marchar o aplaudir el pulso de una canci√≥n conocida.</li>
                                <li>Crear patrones r√≠tmicos con s√≠labas r√≠tmicas (ej: 'Ta' para negra, 'Ti-ti' para corcheas). Conceptos clave: ${currentCurriculum.rhythm.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                            </ul>
                        </li>
                        <li><strong>Percusi√≥n Corporal y Ostinatos (Orff):</strong>
                            <ul>
                                <li>Experimentar con diferentes sonidos corporales (palmas, rodillas, pies).</li>
                                <li>Crear un ostinato r√≠tmico simple en grupo con percusi√≥n corporal o instrumentos de percusi√≥n menor.
                                    <span class="methodology-note">üí° Sugerencia: Si aplica, introducir el concepto de <strong>${currentCurriculum.texture.includes('Ostinato') ? 'ostinato' : 'repetici√≥n'}</strong>.</span>
                                </li>
                            </ul>
                        </li>
                        <li><strong>Juego r√≠tmico con improvisaci√≥n (Gordon):</strong> Un alumno o el profesor propone un patr√≥n r√≠tmico corto, y los dem√°s lo improvisan con variaciones usando la voz o peque√±os instrumentos, aplicando: ${currentCurriculum.rhythm.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                    </ul>
                    `,
                    currentCurriculum.rhythm.join(', ')
                );

                // c. Desarrollo Mel√≥dico y Vocal
                htmlContent += sectionTemplate(
                    'melody',
                    'c. Desarrollo Mel√≥dico y Vocal',
                    sectionTimes['melody'],
                    `
                    <ul class="list-disc ml-6">
                        <li><strong>Trabajo con canciones (Kod√°ly):</strong>
                            <ul>
                                <li>Aprender una canci√≥n nueva (ej: del repertorio folcl√≥rico o infantil) usando gestos manuales Kod√°ly para los grados de la escala (ej: ${currentCurriculum.melody.includes('Sol-Mi') ? 'Sol-Mi' : 'Sol-Mi-La'}).</li>
                                <li>Cantar la canci√≥n afinado, prestando atenci√≥n a la direcci√≥n mel√≥dica (Agudo/Grave). Conceptos clave: ${currentCurriculum.melody.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                            </ul>
                        </li>
                        <li><strong>Improvisaci√≥n mel√≥dica (Orff, Gordon):</strong>
                            <ul>
                                <li>Sobre un bord√≥n sencillo (ej: Do-Sol), los alumnos improvisan peque√±as frases mel√≥dicas vocalmente o con un instrumento mel√≥dico Orff (xil√≥fono), explorando: ${currentCurriculum.melody.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                                <li>Juego de pregunta-respuesta mel√≥dica.</li>
                            </ul>
                        </li>
                        <li><strong>Reconocimiento mel√≥dico:</strong> Cantar una frase y pedir a los alumnos que la identifiquen o la representen con gestos.</li>
                    </ul>
                    `,
                    currentCurriculum.melody.join(', ')
                );

                // d. Exploraci√≥n Instrumental
                htmlContent += sectionTemplate(
                    'instrumental',
                    'd. Exploraci√≥n Instrumental (Enfoque Orff y otros)',
                    sectionTimes['instrumental'],
                    `
                    <ul class="list-disc ml-6">
                        <li><strong>Introducci√≥n a instrumentos Orff:</strong>
                            <ul>
                                <li>Explorar los xil√≥fonos, metal√≥fonos y glockenspiels. Conocer sus nombres y c√≥mo se tocan.</li>
                                <li>Tocar bordones sencillos o ostinatos mel√≥dicos sobre una canci√≥n. Conceptos clave: ${currentCurriculum.texture.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                            </ul>
                        </li>
                        <li><strong>Creaci√≥n de acompa√±amientos:</strong> Dividir la clase en grupos, algunos cantan la melod√≠a, otros tocan un ostinato r√≠tmico, y otros un bord√≥n mel√≥dico. Explorar la <strong>Textura</strong> (${currentCurriculum.texture.includes('Solo/Grupo') ? 'Solo/Grupo' : 'interacci√≥n grupal'}).</li>
                        <li><strong>Combinaci√≥n metodol√≥gica:</strong>
                            <span class="methodology-note">üí° Comenzar con una canci√≥n Kod√°ly para internalizar la melod√≠a (Sol-Mi), luego transferirla a los xil√≥fonos Orff y a√±adir un bord√≥n. Finalmente, crear un movimiento Dalcroze que represente la frase mel√≥dica, aplicando: ${currentCurriculum.texture.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</span>
                        </li>
                        <li><strong>Improvisaci√≥n con instrumentos:</strong> Dar la oportunidad de que los alumnos improvise con algunos instrumentos Orff (manteniendo la pentat√≥nica para facilitar la improvisaci√≥n).</li>
                    </ul>
                    `,
                    currentCurriculum.texture.join(', ')
                );

                // e. Movimiento y Expresi√≥n
                htmlContent += sectionTemplate(
                    'movement',
                    'e. Movimiento y Expresi√≥n (Enfoque Dalcroze y Orff)',
                    sectionTimes['movement'],
                    `
                    <ul class="list-disc ml-6">
                        <li><strong>Movimiento libre y guiado (Dalcroze):</strong>
                            <ul>
                                <li>Escuchar una pieza musical corta y expresar con el cuerpo el <strong>tempo</strong> (lento/r√°pido), <strong>din√°micas</strong> (forte/piano), y el <strong>fraseo</strong>. Conceptos clave: ${currentCurriculum.expression.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                                <li>Caminar o correr libremente por el espacio seg√∫n el pulso de la m√∫sica, y "congelarse" al silencio.</li>
                            </ul>
                        </li>
                        <li><strong>Juegos de movimiento que refuerzan conceptos:</strong>
                            <ul>
                                <li>Juego de "estatua r√≠tmica": al detenerse la m√∫sica, los alumnos deben congelarse en una posici√≥n que represente un ritmo o una forma (ej: ${currentCurriculum.form.includes('AA') ? 'AA' : 'Igual/Diferente'}).</li>
                                <li>Representar con el cuerpo la forma de una canci√≥n (ej: secci√≥n A con un movimiento, secci√≥n B con otro). Conceptos clave: ${currentCurriculum.form.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                            </ul>
                        </li>
                    </ul>
                    `,
                    currentCurriculum.expression.concat(currentCurriculum.form).join(', ')
                );

                // f. Actividad Creativa / Improvisaci√≥n / Composici√≥n Elemental
                htmlContent += sectionTemplate(
                    'creative',
                    'f. Actividad Creativa / Improvisaci√≥n / Composici√≥n Elemental',
                    sectionTimes['creative'],
                    `
                    <ul class="list-disc ml-6">
                        <li><strong>Creaci√≥n de patrones (Gordon, Orff):</strong>
                            <ul>
                                <li>En parejas o peque√±os grupos, crear una frase r√≠tmica corta usando s√≠labas r√≠tmicas o percusi√≥n corporal, y luego ense√±arla al resto de la clase, aplicando: ${currentCurriculum.rhythm.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                                <li>Composici√≥n elemental de melod√≠as simples en los xil√≥fonos (usando 2-3 notas del repertorio aprendido), explorando: ${currentCurriculum.melody.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                            </ul>
                        </li>
                        <li><strong>Improvisaci√≥n vocal o instrumental:</strong> Sobre un acompa√±amiento simple (profesor al piano, guitarra, o un bord√≥n Orff), invitar a los alumnos a improvisar una melod√≠a o un patr√≥n r√≠tmico.</li>
                        <li><strong>Combinaci√≥n metodol√≥gica:</strong>
                            <span class="methodology-note">üí° Explorar un patr√≥n r√≠tmico con s√≠labas Kod√°ly, luego con percusi√≥n corporal, despu√©s improvisar variaciones sobre ese patr√≥n usando la voz (Gordon) y luego instrumentos Orff.</span>
                        </li>
                    </ul>
                    `,
                    currentCurriculum.rhythm.concat(currentCurriculum.melody).join(', ')
                );

                // g. Escucha Activa y Apreciaci√≥n / "Otro"
                htmlContent += sectionTemplate(
                    'listening',
                    'g. Escucha Activa y Apreciaci√≥n / "Otro"',
                    sectionTimes['listening'],
                    `
                    <ul class="list-disc ml-6">
                        <li><strong>Audici√≥n guiada:</strong> Escuchar una pieza musical corta (ej: "Carnaval de los Animales" de Saint-Sa√´ns para identificar instrumentos).
                            <ul>
                                <li>Identificar instrumentos (ej: <strong>${currentCurriculum.other.includes('Instrumentos de la orquesta') ? 'instrumentos de la orquesta' : 'percusi√≥n de altura indeterminada'}</strong>).</li>
                                <li>Identificar la <strong>Forma</strong> (ej: "Esta secci√≥n es igual a la primera, esta es diferente"). Conceptos clave: ${currentCurriculum.form.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                            </ul>
                        </li>
                        <li><strong>Introducci√≥n a la teor√≠a y notaci√≥n (seg√∫n edad):</strong>
                            <ul>
                                <li>Mostrar una negra o una corchea en el pizarr√≥n y relacionarla con el sonido o gesto ya aprendido.</li>
                                <li>Si aplica, introducci√≥n visual de la <strong>${currentCurriculum.other.includes('Clave de Sol') ? 'Clave de Sol' : 'signos de repetici√≥n'}</strong>, as√≠ como: ${currentCurriculum.other.map(c => `<span class="concept-tag">${c}</span>`).join('')}.</li>
                            </ul>
                        </li>
                    </ul>
                    `,
                    currentCurriculum.other.concat(currentCurriculum.form).join(', ')
                );

                // h. Cierre y Relajaci√≥n
                htmlContent += sectionTemplate(
                    'closing',
                    'h. Cierre y Relajaci√≥n',
                    sectionTimes['closing'],
                    `
                    <ul class="list-disc ml-6">
                        <li><strong>Canci√≥n de despedida:</strong> Cantar una canci√≥n tranquila que se√±ale el final de la clase.</li>
                        <li><strong>Reflexi√≥n breve:</strong> Pedir a los alumnos que nombren una cosa que aprendieron o disfrutaron de la clase.</li>
                        <li><strong>Respiraci√≥n y estiramientos:</strong> Ejercicios suaves de respiraci√≥n para volver a la calma.</li>
                    </ul>
                    `,
                    '' // No specific curriculum concepts directly tied to closing for LLM
                );


                lessonPlanOutput.innerHTML = htmlContent;
                lessonPlanOutput.classList.remove('hidden');

                // Attach event listeners to the new LLM buttons
                document.querySelectorAll('#lessonPlanOutput button[data-section]').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const sectionKey = event.target.dataset.section;
                        const type = event.target.dataset.type; // 'activity' or 'assessment'
                        const outputDiv = document.getElementById(`${sectionKey}-llm-output-${type}`);
                        outputDiv.classList.remove('hidden'); // Show the div

                        // Call the LLM generation function
                        generateLLMContent(sectionKey, ageRange, type, currentCurriculum);
                    });
                });
            });

            // Trigger click on page load to show an initial plan
            generatePlanBtn.click();
        });
    </script>
</body>
</html>
